<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>D-PHY Timing Calculator</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" type="image/png" href="imgs/favicon.ico" />
    <style>
      @media (max-width: 900px) {
        description-box.absolute-left {
          display: none !important;
        }
        .main-content-padded {
          padding-left: 0 !important;
        }
      }
      .description-box.absolute-left {
        position: absolute;
        left: 0;
        top: 8rem;
        max-width: 340px;
        margin: 0;
        z-index: 1;
      }
      .main-content-padded {
        padding-left: 370px;
        width: 100%;
        box-sizing: border-box;
      }
      /* New styles for flexbox description row */
      .dphy-description-row {
        display: flex;
        flex-direction: row;
        gap: 2rem;
        width: 100%;
        justify-content: center;
        margin-bottom: 1.2rem;
      }
      .dphy-bg-container {
        background: white;
        padding: 2rem 0;
        min-height: calc(100vh - 8rem);
      }
      .img-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .img-modal.show {
        display: flex !important;
      }
      .img-modal-content {
        max-width: 90vw;
        max-height: 90vh;
        margin: 0;
        display: block;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <header class="main-banner">
      <div class="banner-content">
        <div style="display: flex; align-items: center; gap: 2rem">
          <a href="https://www.latticesemi.com/" target="_blank" rel="noopener">
            <img
              src="imgs/Lattice Logo Yellow_White.png"
              alt="Lattice Semiconductor Logo"
              class="banner-logo"
            />
          </a>
          <nav class="top-nav">
            <a href="index.html" class="nav-link">MIPI Configuration</a>
            <a href="dphy.html" class="nav-link active">Soft D-PHY Parameter</a>
            <a href="video_timing.html" class="nav-link">Video Timing</a>
          </nav>
        </div>
      </div>
    </header>
    <div class="dphy-bg-container">
      <main>
        <!-- Top description row as flexbox, matching video_timing.html -->
        <div
          class="dphy-description-row"
          style="
            display: flex;
            flex-direction: row;
            gap: 2rem;
            width: 100%;
            justify-content: center;
            margin-bottom: 1.2rem;
            margin-top: -1.5rem;
          "
        >
          <!-- Description column -->
          <div
            class="description-box"
            style="
              max-width: 380px;
              min-width: 260px;
              margin-top: 2rem;
              background: rgba(255, 255, 255, 0.05);
              padding: 1.5rem;
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.1);
            "
          >
            <h2 style="display:flex; align-items:center; gap:0.6rem;">
              Soft D-PHY Timing Calculator
              <span
                class="diagram-tooltip"
                tabindex="0"
                aria-label="Open RX Timing Diagram"
                style="display:inline-block; position:relative; color:#fcdf50; font-weight:bold; cursor:pointer;"
              >
                ⓘ
                <div
                  class="diagram-tooltip-content"
                  style="display:none; position:absolute; left:0; z-index:1200; background:#fefbe8; color:#000; padding:0.6rem; border-radius:6px; border:1px solid rgba(0,0,0,0.08); width:320px;"
                >
                  <div style="font-weight:bold; margin-bottom:0.4rem;">RX Timing Diagram</div>
                  <img
                    src="imgs/rxtiming_lightmode.svg"
                    alt="RX Timing Diagram preview"
                    style="width:100%; height:auto; display:block; cursor:zoom-in; border-radius:4px;"
                  />

              </span>
            </h2>
            <p style="font-weight: normal">
              Lattice Radiant automatically calculates protocol timing
              parameters based on user input. However, users can also customize
              these parameters. This tool assists in calculating alternative
              D-PHY timing parameter values.<br />
              <strong>THIS IS MEANT TO BE USED FOR SOFT D-PHY ONLY</strong>
            </p>
            <div style="margin-top: 1rem; font-weight: normal">
              <a
                href="https://www.latticesemi.com/Products/DesignSoftwareAndIP/IntellectualProperty/IPCore/IPCores04/CSI2DSIDPHYTransmitter"
                target="_blank"
                rel="noopener"
                style="color: #50affc; text-decoration: underline"
                >Lattice MIPI D-PHY TX Page</a
              >
              <br /><br />
              <a
                href="https://www.latticesemi.com/Products/DesignSoftwareAndIP/IntellectualProperty/IPCore/IPCores04/CSI2DSIDPHYReceiver"
                target="_blank"
                rel="noopener"
                style="color: #50affc; text-decoration: underline"
                >Lattice MIPI D-PHY RX Page</a
              >
              <br /><br />
              <div style="font-size:0.8em; color:#888; margin-top:0; width:180px;">Use the (ⓘ) icon for diagram preview</div>
            </div>
          </div>
          <!-- Instructions column -->
          <div
            class="description-box"
            style="
              max-width: 380px;
              min-width: 260px;
              margin-top: 2rem;
              background: rgba(255, 255, 255, 0.05);
              padding: 1.5rem;
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.1);
            "
          >
            <h2>Instructions</h2>
            <ol style="font-weight: normal; padding-left: 1.2rem">
              <li>
                Insert desired D-PHY Clock Frequency and Bit Rate into their
                fields.
              </li>
              <li>
                Press "Calculate" to show the values for TX timing parameters
                and DX timing output.
              </li>
              <li>
                Choose a value between Min and Max for each parameter for your
                own design.
              </li>
            </ol>
            <h2>Customizing TX Soft D-PHY Protocol Timing Parameters:</h2>
            <ol
              style="
                font-weight: normal;
                padding-left: 1.2rem;
                margin-top: 0rem;
              "
            >
              <li>
                In Lattice Radiant, open the "Module/IP Block Wizard" for the TX
                D-PHY IP.
              </li>
              <li>Navigate to the "Protocol Timing Parameter tab".</li>
              <li>Select the "Customize TX Timing Parameter Values" option.</li>
              <li>
                Modify the parameters according to the values provided by this
                tool.
              </li>
              <li>Click the "Generate" button to save your changes.</li>
            </ol>
          </div>
        </div>
        <!-- Main content row as flexbox -->
        <div class="main-content-padded">
          <div
            style="
              display: flex;
              flex-direction: column;
              align-items: center;
              width: 100%;
              margin-left: 0;
              margin-top: 0;
            "
          >
            <div
              class="container center-fields"
              style="min-width: 840px; position: relative; align-self: center"
            >
              <form id="dphy-form" autocomplete="off">
                <div class="field-group">
                  <label for="bit-rate">Bit Rate (Mbps):</label>
                  <input
                    type="number"
                    id="bit-rate"
                    min="80"
                    max="2500"
                    step="1"
                    placeholder="80-2500"
                    required
                  />
                </div>
                <div
                  class="button-row"
                  style="margin-top: 1.2rem; display: flex; gap: 1.2rem"
                >
                  <button
                    type="reset"
                    class="action-btn"
                    style="min-width: 120px"
                  >
                    Clear
                  </button>
                  <button
                    type="button"
                    id="calc-dphy-btn"
                    class="action-btn"
                    style="min-width: 120px"
                  >
                    Calculate
                  </button>
                </div>
                <!-- Output section for UI(ps) and Byte Clock Period -->
                <div
                  id="dphy-extra-outputs"
                  style="
                    margin-top: 1.2rem;
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                    align-items: flex-start;
                    color: #ffffff;
                  "
                >
                  <div>
                    <strong>UI (ps):</strong> <span id="out-ui-ps"></span>
                  </div>
                  <div>
                    <strong>D-PHY Clock Frequency (MHz):</strong>
                    <span id="dphy-clock"></span>
                  </div>
                  <div>
                    <strong>Byte Clock Period (ps):</strong>
                    <span id="out-byte-clock-period"></span>
                  </div>
                  <div>
                    <strong>D-PHY Clock Period (ns):</strong>
                    <span id="out-clock-per-min"></span>
                  </div>
                  <div>
                    <strong>Byte Clock Frequency (MHz):</strong>
                    <span id="out-byte-freq-min"></span>
                  </div>
                </div>
              </form>
            </div>
            <div
              class="description-box"
              style="max-width: 900px; margin: 0 auto; margin-top: 2rem"
            >
              <div class="desc-title" style="margin-top: 3rem">
                TX Timing Outputs
              </div>
              <table
                class="table-border"
                id="dphy-output-table"
                style="width: 100%; margin-top: 1.2rem"
              >
                <thead>
                  <tr style="font-weight: bold">
                    <td>Parameter</td>
                    <td>Min</td>
                    <td>Max</td>
                    <td>IP Default</td>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>t_LPX</td>
                    <td id="out-lpx-min"></td>
                    <td id="out-lpx-max"></td>
                    <td id="out-lpx-choice"></td>
                  </tr>
                  <tr>
                    <td>t_HS-PREPARE</td>
                    <td id="out-hs-prepare-min"></td>
                    <td id="out-hs-prepare-max"></td>
                    <td id="out-hs-prepare-choice"></td>
                  </tr>
                  <tr>
                    <td>TX_TCLK_HSZERO</td>
                    <td id="out-tclk-hszero-min"></td>
                    <td id="out-tclk-hszero-max"></td>
                    <td id="out-tclk-hszero-choice"></td>
                  </tr>
                  <tr>
                    <td>t_HS_TRAIL</td>
                    <td id="out-hs-trail-min"></td>
                    <td id="out-hs-trail-max"></td>
                    <td id="out-hs-trail-choice"></td>
                  </tr>
                  <tr>
                    <td>t_HS_EXIT</td>
                    <td id="out-hs-exit-min"></td>
                    <td id="out-hs-exit-max"></td>
                    <td id="out-hs-exit-choice"></td>
                  </tr>
                  <tr>
                    <td>t_CLK-Prepare</td>
                    <td id="out-clk-prepare-min"></td>
                    <td id="out-clk-prepare-max"></td>
                    <td id="out-clk-prepare-choice"></td>
                  </tr>
                  <tr>
                    <td>t_CLK-ZERO</td>
                    <td id="out-clk-zero-min"></td>
                    <td id="out-clk-zero-max"></td>
                    <td id="out-clk-zero-choice"></td>
                  </tr>
                  <tr>
                    <td>t_CLK-PRE</td>
                    <td id="out-clk-pre-min"></td>
                    <td id="out-clk-pre-max"></td>
                    <td id="out-clk-pre-choice"></td>
                  </tr>
                  <tr>
                    <td>t_CLK-POST</td>
                    <td id="out-clk-post-min"></td>
                    <td id="out-clk-post-max"></td>
                    <td id="out-clk-post-choice"></td>
                  </tr>
                  <tr>
                    <td>t_CLK-TRAIL</td>
                    <td id="out-clk-trail-min"></td>
                    <td id="out-clk-trail-max"></td>
                    <td id="out-clk-trail-choice"></td>
                  </tr>
                  <tr>
                    <td>t_CLK-EXIT</td>
                    <td id="out-clk-exit-min"></td>
                    <td id="out-clk-exit-max"></td>
                    <td id="out-clk-exit-choice"></td>
                  </tr>
                </tbody>
              </table>
              <!-- New Data_Settle Table -->
              <div
                class="desc-title"
                style="margin-top: 2.5rem; max-width: 900px"
              >
                RX Timing Outputs
              </div>
              <table
                class="table-border"
                id="dphy-rx-output-table"
                style="width: 100%; margin-top: 1.2rem; margin-bottom: 2rem"
              >
                <thead>
                  <tr style="font-weight: bold">
                    <td>Parameter</td>
                    <td>Min</td>
                    <td>Max</td>
                    <td>IP Default</td>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Data_Settle</td>
                    <td id="out-data-settle-min"></td>
                    <td id="out-data-settle-max"></td>
                    <td id="out-data-settle-choice"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
      <script src="dphy.js"></script>
      <script src="video_timing.js"></script>
      <div id="imgModal" class="img-modal" style="display: none">
        <span
          class="img-modal-close"
          id="imgModalClose"
          style="
            position: absolute;
            top: 20px;
            right: 40px;
            font-size: 40px;
            color: #fff;
            cursor: pointer;
            z-index: 11;
          "
          >&times;</span
        >
        <img
          class="img-modal-content"
          id="imgModalContent"
          style="
            max-width: 90vw;
            max-height: 90vh;
            margin: 0;
            display: block;
            border-radius: 8px;
          "
        />
      </div>
      <script>
        // Enlarge image on click
        document.getElementById("rxTimingDiagram").onclick = function () {
          var modal = document.getElementById("imgModal");
          modal.classList.add("show");
          document.getElementById("imgModalContent").src = this.src;
        };
        document.getElementById("imgModalClose").onclick = function () {
          document.getElementById("imgModal").classList.remove("show");
        };
        // Close modal when clicking outside the image
        document.getElementById("imgModal").onclick = function (e) {
          if (e.target === this) this.classList.remove("show");
        };
        // Tooltip + modal behavior for RX Timing Diagram (mirrors video timing implementation)
        (function() {
          const trigger = document.querySelector('.diagram-tooltip');
          if(!trigger) return;
          const originalContent = trigger.querySelector('.diagram-tooltip-content');
          if(!originalContent) return;
          originalContent.style.display = 'none';

          const modal = document.getElementById('imgModal');
          let modalImg = document.getElementById('imgModalContent');
          const modalClose = document.getElementById('imgModalClose');

          if(!modal || !modalImg) {
            // Create modal if missing
            const m = document.createElement('div');
            m.id = 'imgModal';
            m.className = 'img-modal';
            m.innerHTML = '<span id="imgModalClose" class="img-modal-close" style="position:absolute;top:20px;right:40px;font-size:40px;color:#fff;cursor:pointer;z-index:11">&times;</span><img id="imgModalContent" class="img-modal-content" />';
            document.body.appendChild(m);
            modal = m; modalImg = document.getElementById('imgModalContent');
          }

          let floating = null;
          function removeFloating(){ if(floating){ try{ document.body.removeChild(floating); }catch(e){} floating=null; } }
          function positionFloating(){ if(!floating) return; const rect = trigger.getBoundingClientRect(); let left = rect.left + window.scrollX; let top = rect.bottom + window.scrollY + 6; const fw = floating.offsetWidth; const fh = floating.offsetHeight; if(left+fw > window.scrollX + window.innerWidth - 8){ left = Math.max(window.scrollX + window.innerWidth - fw - 8,8);} if(top+fh > window.scrollY + window.innerHeight - 8){ top = rect.top + window.scrollY - fh - 8; } floating.style.left = left + 'px'; floating.style.top = top + 'px'; }
          function createFloating(){ if(floating) return; floating = originalContent.cloneNode(true); floating.style.display='block'; floating.style.position='absolute'; floating.style.zIndex='4000'; document.body.appendChild(floating); positionFloating(); const img = floating.querySelector('img'); if(img){ img.addEventListener('click', () => openModal(img.src, img.alt)); }
          }
          function openModal(src, alt){ modalImg.alt = alt || ''; modal.classList.add('show'); modalImg.onload = null; modalImg.src = src; }
          function closeModal(){ modal.classList.remove('show'); modalImg.src=''; }

          trigger.addEventListener('mouseenter', () => { createFloating(); });
          trigger.addEventListener('focus', () => { createFloating(); });
          trigger.addEventListener('mouseleave', () => { removeFloating(); });
          trigger.addEventListener('blur', () => { removeFloating(); });
          window.addEventListener('scroll', positionFloating, { passive:true });
          window.addEventListener('resize', positionFloating);

          if(modalClose){ modalClose.addEventListener('click', closeModal); }
          if(modal){ modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); }); }
        })();
      </script>
    </div>
  </body>
</html>
